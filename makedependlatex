#!/bin/bash
# Copyright 2012 Wenjun Deng

VERSION="2012-04-03 14:23:56-04:00"

if [ -z "${1}" ];
then
	echo "makedependlatex version ${VERSION}"
	echo "Generate dependency file from latex source to include in Makefile."
	echo "Usage: makedependlatex <latex file name>"
	exit
fi
if [ ! -f ${1} ];
then
	echo "File ${1} does not exist."
	exit 1
fi

dependfile=`echo ${1} | sed 's/\(\.[^\.]*\)\?$/.d/'`
pdffile=`echo ${1} | sed 's/\(\.[^\.]*\)\?$/.pdf/'`
dvifile=`echo ${1} | sed 's/\(\.[^\.]*\)\?$/.dvi/'`

# find input/include files
# to do

# find figures
# if one line has multiple figures, only one of them will be found. this needs to be fixed.
# if a line has "\%", the following operation will treat it as a commented line. this needs to be fixed.
sed -n 's/^[^%]*\\\(includegraphics\|begin{overpic}\)\(\[.*\]\)\?{\(.*\)}.*$/\3/p' ${1} > ${dependfile}

# find bib files
# to do

sort -u ${dependfile} -o ${dependfile}~
paste -s --delimiters=" " ${dependfile}~ > ${dependfile}
sed -i "s/^.*$/# Generated by makedependlatex ${version}: `date`\n\n${pdffile} : &\n\n${dvifile} : &/" ${dependfile}
rm -f ${dependfile}~

