#!/bin/bash

# Copyright 2012 Wenjun Deng <wdeng@wdeng.info>

# This file is part of Omega Tools.

# Omega Tools is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# Omega Tools is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with Omega Tools.  If not, see <http://www.gnu.org/licenses/>.

VERSION='2012-04-15 23:22:18-04:00'

if [ -z "${1}" ];
then
	echo
	echo "gpmpapplyexpal version ${VERSION}"
	echo
	echo "Process .mp file processed by gpmpextendpalette to use the extended palette."
	echo "In gnuplot, use one style for the lines (points) that are wanted to use the"
	echo "extended palette.  Then after processing through gnuplot, open the generated"
	echo ".mp file to find out the linetype and color for that style.  Fill this"
	echo "information in the following syntax."
	echo
	echo "Usage: gpmpapplyexpal <.mp file generated by gnuplot> <linetype> <color>"
	echo
	exit
fi
if [ ! -f ${1} ];
then
	echo "File ${1} does not exist."
	exit 1
fi
if [ -z "${2}" ];
then
	echo "<linetype> missing."
	exit 1
fi
if [ -z "${3}" ];
then
	echo "<color> missing."
	exit 1
fi

cp ${1} ${1}~

sed -i ':a;N;$!ba;s/linetype '${2}';\ncurrentcolor:=col'${3}';/linetype '${2}';\ncurrentcolor:=col<extendedcolor>;/g' ${1}
awk 'BEGIN {color=8} {if (flag==1 && match($0,"put_text")) color--;flag=0;if (sub(/<extendedcolor>/,color)) {color++;flag=1} print}' ${1} > ${1}.tmp
mv ${1}.tmp ${1}

